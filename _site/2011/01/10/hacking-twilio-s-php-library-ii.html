<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width; initial-scale=1.0">
  <title>Hacking Twilio's PHP library II | Opeyemi's BS</title>
  <link href="http://fonts.googleapis.com/css?family=Libre+Baskerville" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/assets/css/style.css" />
  <link rel="stylesheet" href="/assets/css/zenburn.css" />
  <link rel="alternate" type="application/atom+xml" title="Feed for blog posts" href="/feed.xml">
</head>
<body>
  <div class="wrapper">
    <nav>
      <a href="/">home</a> &middot; <a href="/posts.html">posts</a> &middot; <a href="/feed.xml">feed</a>
    </nav>
    <header>
        <h1>Hacking Twilio's PHP library II</h1>
        <time>10 Jan 2011</time>
    </header>
    <article>
        <p>So here are three more hacks for the Twilio PHP library.</p>
<p><strong>1. Support for both XML and JSON</strong></p>
<p>In <a href="/2010/12/30/twilio-s-php-library-support-for-json.html">my last piece</a>, I posted a code hack that enables using the JSON endpoints of the API instead of the XML. What if we can find a way to support both? Here is a rewrite of the <strong>TwilioRestResponse</strong> constructor class to do that.</p>
<p><div class="highlight"><pre><code class="php"><span class="lineno"> 1</span> <span class="cp">&lt;?php</span>
<span class="lineno"> 2</span> <span class="c1">// ...</span>
<span class="lineno"> 3</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$text</span><span class="p">,</span> <span class="nv">$status</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 4</span>     <span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/([^?]+)\??(.*)/&#39;</span><span class="p">,</span> <span class="nv">$url</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
<span class="lineno"> 5</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Url</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="lineno"> 6</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">QueryString</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="lineno"> 7</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ResponseText</span> <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
<span class="lineno"> 8</span>     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">HttpStatus</span> <span class="o">=</span> <span class="nv">$status</span><span class="p">;</span>
<span class="lineno"> 9</span>     
<span class="lineno">10</span>     <span class="c1">// Lets check for XML first</span>
<span class="lineno">11</span>     <span class="c1">// ...easier to detect that Json</span>
<span class="lineno">12</span>     <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">HttpStatus</span> <span class="o">!=</span> <span class="mi">204</span><span class="p">)</span>
<span class="lineno">13</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Response</span> <span class="o">=</span> <span class="o">@</span><span class="nb">simplexml_load_string</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>
<span class="lineno">14</span>     
<span class="lineno">15</span>     <span class="c1">// If it fails, then prolly json</span>
<span class="lineno">16</span>     <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Response</span> <span class="o">===</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">17</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Response</span> <span class="o">=</span> <span class="o">@</span><span class="nb">json_decode</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>
<span class="lineno">18</span>         <span class="nv">$isJson</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
<span class="lineno">19</span>     <span class="p">}</span>
<span class="lineno">20</span>     
<span class="lineno">21</span>     <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">IsError</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$status</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">))</span>
<span class="lineno">22</span>         <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ErrorMessage</span> <span class="o">=</span>
<span class="lineno">23</span>             <span class="nv">$isJson</span> <span class="o">?</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Response</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">:</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Response</span><span class="o">-&gt;</span><span class="na">RestException</span><span class="o">-&gt;</span><span class="na">Message</span><span class="p">;</span>
<span class="lineno">24</span>     
<span class="lineno">25</span> <span class="p">}</span>
</code></pre></div></p>
<p>Notice that the result of your API is now available via <strong>$this->Response</strong> and not <strong>$this->ResponseJson </strong>or<strong> $this->ResponseXML</strong>. You will also notice I checked for XML first. For some funny reasons, trying to <strong>json_decode</strong> an XML string gives a valid result but parsing a JSON string with simplexml fails. So that explains why.</p>
<p><strong>2. Support for Reject</strong></p>
<p>Trying to construct a <a href="http://www.twilio.com/docs/api/2010-04-01/twiml/reject">Reject</a> response gives an error with the library. In other words, the following code will fail:</p>
<p><div class="highlight"><pre><code class="php"><span class="lineno">1</span> <span class="cp">&lt;?php</span>
<span class="lineno">2</span> <span class="c1">// ...</span>
<span class="lineno">3</span> <span class="nv">$r</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">();</span>
<span class="lineno">4</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">append</span><span class="p">(</span><span class="k">new</span> <span class="nx">Reject</span><span class="p">());</span>
</code></pre></div></p>
<p>The simple workaround is including '<strong>Reject</strong>' in the nesting array of the <strong>Response class</strong>:</p>
<p><div class="highlight"><pre><code class="php"><span class="lineno">1</span> <span class="cp">&lt;?php</span>
<span class="lineno">2</span> <span class="c1">// ...</span>
<span class="lineno">3</span> <span class="k">class</span> <span class="nc">Response</span> <span class="k">extends</span> <span class="nx">Verb</span> <span class="p">{</span>
<span class="lineno">4</span>     <span class="k">private</span> <span class="nv">$xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2"> encoding=</span><span class="se">\&quot;</span><span class="s2">UTF-8</span><span class="se">\&quot;</span><span class="s2">?&gt;&lt;Response&gt;&lt;/Response&gt;&quot;</span><span class="p">;</span>
<span class="lineno">5</span>     <span class="k">protected</span> <span class="nv">$nesting</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;Say&#39;</span><span class="p">,</span> <span class="s1">&#39;Play&#39;</span><span class="p">,</span> <span class="s1">&#39;Gather&#39;</span><span class="p">,</span> <span class="s1">&#39;Record&#39;</span><span class="p">,</span> 
<span class="lineno">6</span>         <span class="s1">&#39;Dial&#39;</span><span class="p">,</span> <span class="s1">&#39;Redirect&#39;</span><span class="p">,</span> <span class="s1">&#39;Pause&#39;</span><span class="p">,</span> <span class="s1">&#39;Hangup&#39;</span><span class="p">,</span> <span class="s1">&#39;Sms&#39;</span><span class="p">,</span> <span class="s1">&#39;Reject&#39;</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>3. Recording DAILed calls</strong></p>
<p>Although there is no official documentation of how to record a conversation instatiated with the <a href="http://www.twilio.com/docs/api/2010-04-01/twiml/dial">DIAL verb</a>, <a href="http://getsatisfaction.com/twilio/topics/recording_a_conversation_between_caller_and_recipient">there is a workaround</a>. Problem is, adding the <strong>record </strong>attribute fails with the library. The hack is to add '<strong>record</strong>' to the <strong>valid </strong>array of the <strong>Dial class</strong></p>
<p><div class="highlight"><pre><code class="php"><span class="lineno">1</span> <span class="cp">&lt;?php</span>
<span class="lineno">2</span> <span class="c1">// ...</span>
<span class="lineno">3</span> <span class="k">class</span> <span class="nc">Dial</span> <span class="k">extends</span> <span class="nx">Verb</span> <span class="p">{</span>
<span class="lineno">4</span>     <span class="k">protected</span> <span class="nv">$valid</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span><span class="s1">&#39;method&#39;</span><span class="p">,</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span><span class="s1">&#39;hangupOnStar&#39;</span><span class="p">,</span>
<span class="lineno">5</span>         <span class="s1">&#39;timeLimit&#39;</span><span class="p">,</span><span class="s1">&#39;callerId&#39;</span><span class="p">,</span><span class="s1">&#39;record&#39;</span><span class="p">);</span>
</code></pre></div></p>
<p>Please note that recording <strong>Dail</strong>ed calls is not officially supported by the API and this feat may change anytime.</p>
<p>You can download the whole <em>new</em> source code of the<strong> Twilio class</strong> here: <a href="http://cl.ly/3wyA">http://cl.ly/3wyA</a></p>
<p>By the way, wanna check out the web app I built with the API? Here: <a href="http://goahoy.com/">goAhoy.com</a>. I'm sending out invites already, so don't forget to drop your number on the signup page.</p>

        <p></p>
        <em><a href="http://twitter.com/kehers">Discuss on twitter.</a></em>
    </article>

    <footer>
      <a href="/">home</a> &middot; <a href="posts.html">posts</a> &middot; <a href="http://github.com/kehers/kehers.github.com">source</a> &middot; <a href="http://twitter.com/kehers">@kehers</a>
    </footer>
  </div>
</body>
</html>