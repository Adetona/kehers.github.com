<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@kehers">
  <meta name="twitter:title" content="SIP on Android">
  <meta name="twitter:description" content="What’s cool about Callbase is allowing businesses manage their calls right there on the browser. Just a sign up; available anywhere; no installs. But what about extending this flexibility to mobile...">
  <meta name="twitter:creator" content="@kehers">
  <title>SIP on Android</title>
  <link href='https://fonts.googleapis.com/css?family=Libre+Baskerville:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Muli' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/assets/css/normalize.css">
  <link rel="stylesheet" href="/assets/css/skeleton.css">
  <link rel="stylesheet" href="/assets/css/custom.css">
  <link rel="stylesheet" href="/assets/css/zenburn.css" />
  <link rel="alternate" type="application/atom+xml" title="Blog post feed" href="/feed.xml">
</head>
<body>

<div class="container">
  <header>
    <div class="row">
      <div id="logo" class="three columns">
      <div id="menu">☰</div>
      <h3><a href="/">/opeyemi</a></h3>
    </div>
      <nav class="nine columns">
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/posts.html">Posts</a></li>
          <li><a href="/feed.xml">RSS Feed</a></li>
          <li><a href="http://gum.co/Sxoj" class="bordered">Consuming REST APIs - a soft introduction</a></li>
      </ul>
      </nav>
    </div>
  </header>
  <div class="row">
    <div class="six offset-by-three columns">
      <article>
        <date>04 Jun 2014</date>
        <h1 class="title">SIP on Android</h1>
        <p>What’s cool about <a href="https://callbase.co/">Callbase</a> is allowing businesses manage their calls right there on the browser. Just a sign up; available anywhere; no installs. But what about extending this flexibility to mobile devices? What about giving agents the flexibility of receiving and making calls on their mobile device anywhere, anytime? Since Callbase is built on SIP, platform portability should be an easy one. The Android platform is one I have been working on for some days now.</p>

<h2 id="the-android-sip-stack">The Android SIP stack</h2>

<p>Android provides a high level <a href="http://developer.android.com/guide/topics/connectivity/sip.html">SIP API</a> from versions 2.3 (Gingerbread) and above. The implementation is straight forward:</p>

<ul>
  <li>Initialize the SipManager</li>
  <li>Build the local Sip profile</li>
  <li>Start the manager with a pending intent for incoming calls</li>
  <li>Send registration requests</li>
</ul>

<p>So here is our SipDemo class</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">String</span> <span class="n">sipAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="kd">public</span> <span class="n">SipManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="kd">public</span> <span class="n">SipProfile</span> <span class="n">me</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="kd">public</span> <span class="n">SipAudioCall</span> <span class="n">call</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="o">...</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">initializeManager</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
  
  <span class="c1">// Initialize manager
</span>
  <span class="k">if</span><span class="o">(</span><span class="n">manager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">SipManager</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">try</span> <span class="o">{</span>
    <span class="c1">// Build the SIP profile
</span>
    <span class="n">SipProfile</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> 
                <span class="k">new</span> <span class="n">SipProfile</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="s">"sip_username"</span><span class="o">,</span> <span class="s">"domain"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"sip_password"</span><span class="o">);</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="c1">// Register a pending intent for incoming calls
</span>
    <span class="n">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">i</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"android.SipDemo.INCOMING_CALL"</span><span class="o">);</span>
    <span class="n">PendingIntent</span> <span class="n">pi</span> <span class="o">=</span> 
        <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FILL_IN_DATA</span><span class="o">);</span>
    <span class="n">manager</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">me</span><span class="o">,</span> <span class="n">pi</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    
    <span class="c1">// Send registration requests
</span>
    <span class="n">manager</span><span class="o">.</span><span class="na">setRegistrationListener</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getUriString</span><span class="o">(),</span>
                    <span class="k">new</span> <span class="n">SipRegistrationListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">onRegistering</span><span class="o">(</span><span class="n">String</span> <span class="n">localProfileUri</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Registering with SIP Server...
</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="n">onRegistrationDone</span><span class="o">(</span><span class="n">String</span> <span class="n">localProfileUri</span><span class="o">,</span>
                                <span class="kt">long</span> <span class="n">expiryTime</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Ready
</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="n">onRegistrationFailed</span><span class="o">(</span><span class="n">String</span> <span class="n">localProfileUri</span><span class="o">,</span>
                            <span class="kt">int</span> <span class="n">errorCode</span><span class="o">,</span> <span class="n">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Registration failed.  Check SIP details
</span>
        <span class="o">}</span>
      <span class="o">});</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ParseException</span> <span class="n">pe</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Connection error
</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SipException</span> <span class="n">se</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Connection error
</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>It is that straight forward. In less than an hour, you can build a simple client that can make and receive calls. To receive calls, you just register a broadcast receiver for the pending intent you registered earlier.</p>

<p>So in our SipDemo class,</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">...</span>
<span class="kd">public</span> <span class="n">IncomingCallReceiver</span> <span class="n">callReceiver</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>

  <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
  <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
  
  <span class="n">IntentFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
  <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="s">"android.SipDemo.INCOMING_CALL"</span><span class="o">);</span>
  <span class="n">callReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IncomingCallReceiver</span><span class="o">();</span>
  <span class="k">this</span><span class="o">.</span><span class="na">registerReceiver</span><span class="o">(</span><span class="n">callReceiver</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>
  
  <span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<p>And here, the broadcast receiver:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IncomingCallReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    
    <span class="n">SipAudioCall</span> <span class="n">incomingCall</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">SIPDemoActivity</span> <span class="n">siActivity</span> <span class="o">=</span> <span class="o">(</span><span class="n">SIPDemoActivity</span><span class="o">)</span> <span class="n">context</span><span class="o">;</span>
    
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// listener for sip manager takeaudio call
</span>
      <span class="n">SipAudioCall</span><span class="o">.</span><span class="na">Listener</span> <span class="n">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SipAudioCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">onRinging</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">,</span> <span class="n">SipProfile</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Ringing UI
</span>
        <span class="o">}</span>
        
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCallEstablished</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Call picked UI
</span>
        <span class="o">}</span>
        
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCallEnded</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Call ended. Back to normal UI
</span>
        <span class="o">}</span>
      <span class="o">};</span>
      <span class="n">incomingCall</span> <span class="o">=</span> <span class="n">siActivity</span><span class="o">.</span><span class="na">manager</span><span class="o">.</span><span class="na">takeAudioCall</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">listener</span><span class="o">);</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">incomingCall</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">incomingCall</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Making calls is as well easy. You don’t need to build a dialer to get started with. For something quick, you can simply intercept calls from the phone’s dialer (<a href="http://kehers.github.io/2014/05/17/back-on-android.html">the beauty of Android</a>). Just register for the <a href="http://developer.android.com/reference/android/content/Intent.html#ACTION_NEW_OUTGOING_CALL">NEW_OUTGOING_CALL</a> intent in your manifest</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">".OutgoingCallReceiver"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;intent-filter&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.NEW_OUTGOING_CALL"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.DEFAULT"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/receiver&gt;</span></code></pre></figure>

<p>Here is our broadcast receiver:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutgoingCallReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>
  
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Get phone number
</span>
    <span class="n">String</span> <span class="n">phoneNumber</span> <span class="o">=</span> <span class="n">getResultData</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">phoneNumber</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">phoneNumber</span> <span class="o">=</span> 
        <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">EXTRA_PHONE_NUMBER</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// Ideally, you will want to prompt the user here
</span>
    <span class="c1">//  ...to confirm using the SipDemo app to call
</span>
    
    <span class="c1">// For now, let's just 'hijack' the call
</span>
    <span class="n">setResultData</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    
    <span class="c1">// Start and pass the phone number to our SipDemo class
</span>
    <span class="n">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span> 
            <span class="n">SipDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">i</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
    <span class="n">i</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">"OUTBOUND_NUMBER"</span><span class="o">,</span> <span class="n">phoneNumber</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>…and back to our SipDemo class</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="n">initializeManager</span><span class="o">();</span>
  
  <span class="c1">// Outbound call?
</span>
  <span class="n">Bundle</span> <span class="n">extras</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">();</span>
  <span class="k">if</span><span class="o">(</span><span class="n">extras</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">outBound</span><span class="o">(</span><span class="n">extras</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"OUTBOUND_NUMBER"</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">outBound</span><span class="p">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">SipAudioCall</span><span class="o">.</span><span class="na">Listener</span> <span class="n">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SipAudioCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">()</span> <span class="o">{</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCalling</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Calling UI
</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCallBusy</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Busy UI?
</span>
      <span class="o">}</span>
      
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCallEstablished</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Call picked UI
</span>
        <span class="n">call</span><span class="o">.</span><span class="na">startAudio</span><span class="o">();</span>
      <span class="o">}</span>
      
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCallEnded</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Ended. Back to normal UI
</span>
      <span class="o">}</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="n">onRingingBack</span><span class="o">(</span><span class="n">SipAudioCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Ringing UI
</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="n">call</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">makeAudioCall</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getUriString</span><span class="o">(),</span> 
                <span class="n">sipAddress</span><span class="o">,</span> <span class="n">listener</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">me</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getUriString</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ee</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ee</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">call</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">call</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>That’s as easy as it can get. You will find more interesting methods to end, mute, hold and all that in the <a href="http://developer.android.com/reference/android/net/sip/SipAudioCall.html">SipAudioCall</a> class. The only other things you have to take care of are normal manifest permissions  and class clean up (unregistering broadcast receivers, closing the manager).</p>

<p>Manifest permissions and feature requests:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- Permissions --&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.PROCESS_OUTGOING_CALLS"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.USE_SIP"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.INTERNET"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.VIBRATE"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_WIFI_STATE"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.WAKE_LOCK"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.RECORD_AUDIO"</span> <span class="nt">/&gt;</span>
<span class="c">&lt;!-- ...and features --&gt;</span>
<span class="nt">&lt;uses-feature</span> <span class="na">android:name=</span><span class="s">"android.hardware.sip.voip"</span> <span class="na">android:required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-feature</span> <span class="na">android:name=</span><span class="s">"android.hardware.wifi"</span> <span class="na">android:required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;uses-feature</span> <span class="na">android:name=</span><span class="s">"android.hardware.microphone"</span> <span class="na">android:required=</span><span class="s">"true"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>Cleaning up, once our [SipDemo] activity is done:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">call</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">call</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">me</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">manager</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">me</span><span class="o">.</span><span class="na">getUriString</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ee</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//
</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">callReceiver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">unregisterReceiver</span><span class="o">(</span><span class="n">callReceiver</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="the-problem">The problem</h2>

<p>Even though the specs states the SIP API is available for Android devices from 2.3, it is not. <strong>The Android SIP API is not supported on all devices.</strong> Interestingly, it is supported on my old 2.3 LG P970 and not my 4.4 Moto G. (By the way, you have to test on real device and not the Android emulator).</p>

<p>We can do a simple test. The <a href="http://developer.android.com/reference/android/net/sip/SipManager.html">SipManager class</a> has some methods to test device support.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="o">...</span>
    
    <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">textview</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">SipManager</span><span class="o">.</span><span class="na">isVoipSupported</span><span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">SipManager</span><span class="o">.</span><span class="na">isApiSupported</span><span class="o">(</span><span class="k">this</span><span class="o">)){</span>
        <span class="c1">// Good to go!        
</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Congrats, your device made it!"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Device not supported
</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"Not supported :/"</span><span class="o">);</span> 
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>In most cases, the API will be supported but not VOIP. And that is a big bummer there. This makes the Android SIP API limiting if you are planning to build something targeted at different devices.</p>

<h2 id="finding-an-alternative">Finding an alternative</h2>

<p>With the Android SIP API out, what are the alternatives? Well, there are a couple of open source SIP stacks for Android. The popular ones people talk about are:</p>

<ul>
  <li><a href="https://java.net/projects/jain-sip/">JAIN</a></li>
  <li><a href="http://www.mjsip.org/">MjSIP</a></li>
  <li><a href="http://www.pjsip.org/">PjSIP</a></li>
  <li><a href="http://www.doubango.org/">Doubango</a></li>
</ul>

<p>Now another problem - choosing. After a full day of experimenting and digging, I finally settled for Doubango. But why Doubango? Two reasons:</p>

<ol>
  <li>High level API  <br />
Some of the stacks offer only low level APIs. They require you to have a good knowledge of the SIP protocol. Nothing is handed to you on a platter of gold. You must know what headers, what messages, what requests to send at the right time. There is nothing like calling a simple <strong>register()</strong> method to help you handle SIP server registration.  <br />
Doubango offers a high level API that makes SIP development a lot easier and faster.</li>
  <li>Platform ready  <br />
Doubango has an Android library that can be integrated easily. All the hard C/Android JNI integration already done.</li>
</ol>

<h2 id="setting-up-doubango">Setting up Doubango</h2>

<p>The journey starts from downloading the Android NGN stack from <a href="https://code.google.com/p/imsdroid/">code.google.com/p/imsdroid/</a>. (The core project is available at <a href="https://code.google.com/p/doubango/source/checkout">code.google.com/p/doubango/source/checkout</a>). There is a PDF (android-ngn-stack-00.pdf) in /branch/2.0 that explains the library setup - importing to Eclipse and creating your project. Once that is done, you can start building.</p>

<p>For me, the PDF documentation didn’t help much as regards development. I had to figure a lot of things by experimenting. The sample source codes and imsdroid source were also helpful.</p>

<h2 id="building-on-the-high-level-api">Building on the [high level] API</h2>

<p>The implementation is similar to that of Android SIP API</p>

<ul>
  <li>Start the ‘library engine’ and SIP service</li>
  <li>Set configuration details</li>
  <li>Register call state and registration state broadcast receivers</li>
  <li>Send registration request</li>
</ul>

<p>Let’s start with the initializing the engine and SIP service and registering the broadcast receivers.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">NgnEngine</span> <span class="n">mEngine</span><span class="o">;</span>
<span class="kd">private</span> <span class="n">INgnSipService</span> <span class="n">mSipService</span><span class="o">;</span>
<span class="kd">private</span> <span class="n">RegistrationBroadcastReceiver</span> <span class="n">regBroadcastReceiver</span><span class="o">;</span>
<span class="kd">private</span> <span class="n">CallStateReceiver</span> <span class="n">callStateReceiver</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>  
  <span class="c1">// Get engines
</span>
  <span class="n">mEngine</span> <span class="o">=</span> <span class="n">NgnEngine</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
  <span class="n">mSipService</span> <span class="o">=</span> <span class="n">mEngine</span><span class="o">.</span><span class="na">getSipService</span><span class="o">();</span>
  
  <span class="c1">// Register broadcast receivers
</span>
  <span class="n">regBroadcastReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RegistrationBroadcastReceiver</span><span class="o">();</span>
  <span class="kd">final</span> <span class="n">IntentFilter</span> <span class="n">intentFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
  <span class="n">intentFilter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">NgnRegistrationEventArgs</span><span class="o">.</span><span class="na">ACTION_REGISTRATION_EVENT</span><span class="o">);</span>
  <span class="n">registerReceiver</span><span class="o">(</span><span class="n">regBroadcastReceiver</span><span class="o">,</span> <span class="n">intentFilter</span><span class="o">);</span>
  <span class="c1">// Incoming call broadcast receiver
</span>
  <span class="kd">final</span> <span class="n">IntentFilter</span> <span class="n">intentRFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
  <span class="n">callStateReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CallStateReceiver</span><span class="o">();</span>
  <span class="n">intentRFilter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">NgnInviteEventArgs</span><span class="o">.</span><span class="na">ACTION_INVITE_EVENT</span><span class="o">);</span>
  <span class="n">registerReceiver</span><span class="o">(</span><span class="n">callStateReceiver</span><span class="o">,</span> <span class="n">intentRFilter</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Here are the receivers:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegistrationBroadcastReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
    <span class="c1">// Registration Event
</span>
    <span class="k">if</span><span class="o">(</span><span class="n">NgnRegistrationEventArgs</span><span class="o">.</span><span class="na">ACTION_REGISTRATION_EVENT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">)){</span>
      <span class="n">NgnRegistrationEventArgs</span> <span class="n">args</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">NgnEventArgs</span><span class="o">.</span><span class="na">EXTRA_EMBEDDED</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Invalid event args"</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">switch</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getEventType</span><span class="o">()){</span>
        <span class="k">case</span> <span class="nl">REGISTRATION_NOK:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Failed to register :("</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">UNREGISTRATION_OK:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"You are now unregistered :)"</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">REGISTRATION_OK:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"You are now registered :)"</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">REGISTRATION_INPROGRESS:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Trying to register..."</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">UNREGISTRATION_INPROGRESS:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Trying to unregister..."</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">UNREGISTRATION_NOK:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Failed to unregister :("</span><span class="o">);</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>

    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallStateReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
    
    <span class="k">if</span><span class="o">(</span><span class="n">NgnInviteEventArgs</span><span class="o">.</span><span class="na">ACTION_INVITE_EVENT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">)){</span>
      <span class="n">NgnInviteEventArgs</span> <span class="n">args</span> <span class="o">=</span> 
                <span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">NgnEventArgs</span><span class="o">.</span><span class="na">EXTRA_EMBEDDED</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Invalid event args"</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="n">NgnAVSession</span> <span class="n">avSession</span>
                <span class="o">=</span> <span class="n">NgnAVSession</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getSessionId</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">avSession</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">final</span> <span class="n">InviteState</span> <span class="n">callState</span> <span class="o">=</span> <span class="n">avSession</span><span class="o">.</span><span class="na">getState</span><span class="o">();</span>
      <span class="n">NgnEngine</span> <span class="n">mEngine</span> <span class="o">=</span> <span class="n">NgnEngine</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
      
      <span class="k">switch</span><span class="o">(</span><span class="n">callState</span><span class="o">){</span>
        <span class="k">case</span> <span class="nl">NONE:</span>
        <span class="k">default</span><span class="o">:</span>
        <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">INCOMING:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Incoming call"</span><span class="o">);</span>
          <span class="c1">// Ring
</span>
          <span class="n">mEngine</span><span class="o">.</span><span class="na">getSoundService</span><span class="o">().</span><span class="na">startRingTone</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">INCALL:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Call connected"</span><span class="o">);</span>
          <span class="n">mEngine</span><span class="o">.</span><span class="na">getSoundService</span><span class="o">().</span><span class="na">stopRingTone</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">TERMINATED:</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Call terminated"</span><span class="o">);</span>
          <span class="n">mEngine</span><span class="o">.</span><span class="na">getSoundService</span><span class="o">().</span><span class="na">stopRingTone</span><span class="o">();</span>
          <span class="n">mEngine</span><span class="o">.</span><span class="na">getSoundService</span><span class="o">().</span><span class="na">stopRingBackTone</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>Before we can send a registeration request, we need to set necessary SIP configuration details. The NGN stack has a configuration utility for this.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">NgnEngine</span> <span class="n">mEngine</span> <span class="o">=</span> <span class="n">NgnEngine</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
<span class="n">INgnConfigurationService</span> <span class="n">mConfigurationService</span>
            <span class="o">=</span> <span class="n">mEngine</span><span class="o">.</span><span class="na">getConfigurationService</span><span class="o">();</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">IDENTITY_IMPI</span><span class="o">,</span>
                                    <span class="s">"sip_username"</span><span class="o">);</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">IDENTITY_IMPU</span><span class="o">,</span> 
        <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"sip:%s@%s"</span><span class="o">,</span> <span class="s">"sip_username"</span><span class="o">,</span> <span class="s">"sip_domain"</span><span class="o">));</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">IDENTITY_PASSWORD</span><span class="o">,</span>
                                    <span class="s">"sip_password"</span><span class="o">);</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">NETWORK_PCSCF_HOST</span><span class="o">,</span> 
                                    <span class="s">"sip_server_host"</span><span class="o">);</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">NETWORK_PCSCF_PORT</span><span class="o">,</span> 
                                    <span class="s">"sip_server_port"</span><span class="o">);</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">NETWORK_REALM</span><span class="o">,</span>
                                    <span class="s">"sip_domain"</span><span class="o">);</span>
<span class="c1">// By default, using 3G for calls disabled
</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">NETWORK_USE_3G</span><span class="o">,</span>
                                    <span class="kc">true</span><span class="o">);</span>
<span class="c1">// You may want to leave the registration timeout to the default 1700 seconds
</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">NgnConfigurationEntry</span><span class="o">.</span><span class="na">NETWORK_REGISTRATION_TIMEOUT</span><span class="o">,</span>
                                <span class="mi">3600</span><span class="o">);</span>
<span class="n">mConfigurationService</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span></code></pre></figure>

<p>The configuration service is persistent. This means you only have to set this values once - say the first time the user logs in. If this has been done (doesn’t matter what activity or when), then you can send the registration request.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="n">initializeManager</span> <span class="o">{</span>
  <span class="k">if</span><span class="o">(!</span><span class="n">mEngine</span><span class="o">.</span><span class="na">isStarted</span><span class="o">()){</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">mEngine</span><span class="o">.</span><span class="na">start</span><span class="o">()){</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Failed to start the engine :("</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="c1">// Register
</span>
  <span class="k">if</span><span class="o">(!</span><span class="n">mSipService</span><span class="o">.</span><span class="na">isRegistered</span><span class="o">()){</span>
    <span class="n">mSipService</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>So how do we make calls? Simple. Create an outgoing call session. For the sake of this post, we will do the same thing we did earlier with Android SIP API - intercept calls from the phone’s dialer</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutgoingCallReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>
  
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">phoneNumber</span> <span class="o">=</span> <span class="n">getResultData</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">phoneNumber</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">phoneNumber</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">EXTRA_PHONE_NUMBER</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="n">setResultData</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">validUri</span> <span class="o">=</span> <span class="n">NgnUriUtils</span><span class="o">.</span><span class="na">makeValidSipUri</span><span class="o">(</span>
      <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"sip:%s@%s"</span><span class="o">,</span> <span class="n">phoneNumber</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">Plivo</span><span class="o">.</span><span class="na">SIP_DOMAIN</span><span class="o">));</span>
    <span class="k">if</span><span class="o">(</span><span class="n">validUri</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Invalid number"</span><span class="o">);</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="n">NgnAVSession</span> <span class="n">avSession</span> <span class="o">=</span> <span class="n">NgnAVSession</span><span class="o">.</span><span class="na">createOutgoingSession</span><span class="o">(</span>
      <span class="n">NgnEngine</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getSipService</span><span class="o">().</span><span class="na">getSipStack</span><span class="o">(),</span> <span class="n">NgnMediaType</span><span class="o">.</span><span class="na">Audio</span><span class="o">);</span>
    <span class="n">avSession</span><span class="o">.</span><span class="na">makeCall</span><span class="o">(</span><span class="n">validUri</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>You will want to start a new activity (let’s call it MakeCallActivity) in that broadcast that will show the user the necessary action buttons (at least an “End call” button) and interact call state with the user. You should also find a way to pass call state from the CallStateReceiver (shown earlier) to this MakeCallActivity. What I did was send call state broadcasts from CallStateReceiver and create listeners within my MakeCallActivity (and ReceiveCallActivity). This will enable you know call states within calls and how to update the UI as necessary.</p>

<p>Receiving calls is just as easy. Remember our CallStateReceiver? Just start a new activity (let’s call it ReceiveCallActivity) to handle incoming calls in the <strong>incoming</strong> call state.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">...</span>
<span class="k">switch</span><span class="o">(</span><span class="n">callState</span><span class="o">){</span>
  <span class="k">case</span> <span class="nl">INCOMING:</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"DEBUG"</span><span class="o">,</span> <span class="s">"Incoming call"</span><span class="o">);</span>
    <span class="c1">// Ringtone
</span>
    <span class="n">mEngine</span><span class="o">.</span><span class="na">getSoundService</span><span class="o">().</span><span class="na">startRingTone</span><span class="o">();</span>
    <span class="c1">// Start a ReceiveActivity                	
</span>
    <span class="n">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">(),</span>
            <span class="n">ReceiveCallActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">i</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
    <span class="n">i</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">SIP_SESSION_ID</span><span class="o">,</span> <span class="n">avSession</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">i</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">PHONE_NUMBER_EXTRA</span><span class="o">,</span> 
            <span class="n">avSession</span><span class="o">.</span><span class="na">getRemotePartyDisplayName</span><span class="o">());</span>
    <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="n">i</span><span class="o">);</span></code></pre></figure>

<p>The activity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReceiveCallActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">NgnAVSession</span> <span class="n">mSession</span><span class="o">;</span>
    
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>   	
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="c1">// Receive UI ('Accept' &amp; 'Reject' button, caller number and co)
</span>
    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">call_in</span><span class="o">);</span>

    <span class="n">Bundle</span> <span class="n">extras</span> <span class="o">=</span> <span class="n">getIntent</span><span class="o">().</span><span class="na">getExtras</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">extras</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
        <span class="n">mSession</span> <span class="o">=</span> <span class="n">NgnAVSession</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="n">extras</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">SIP_SESSION_ID</span><span class="o">));</span>
        <span class="c1">// Phone number -&gt; extras.getString(Constants.PHONE_NUMBER_EXTRA)
</span>
    <span class="o">}</span>
    
    <span class="c1">// Wake the screen and ignore "face touches"
</span>
    <span class="n">getWindow</span><span class="o">().</span><span class="na">addFlags</span><span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_TURN_SCREEN_ON</span><span class="o">|</span>
                <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_SHOW_WHEN_LOCKED</span><span class="o">|</span>
                <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_IGNORE_CHEEK_PRESSES</span><span class="o">);</span>
    
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="n">acceptBtnClicked</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">){</span>
    <span class="n">mSession</span><span class="o">.</span><span class="na">acceptCall</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kt">void</span> <span class="n">rejectBtnClicked</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">mSession</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">mSession</span><span class="o">.</span><span class="na">hangUpCall</span><span class="o">();</span>
        <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span></code></pre></figure>

<h2 id="in-conclusion">In conclusion</h2>

<p>It is interesting to see and experiment with the many possibilities of SIP on Android. Doubango may not be the perfect library for you. If you are a core SIP developer, you may want to consider the low level APIs like JAIN and MjSIP.</p>

<p>I have been using the Callbase for Android app (alpha) to make and receive calls on my Moto G. (I don’t have a SIM. I created a personal organisation and purchased a US number on Callbase). It works ok but still needs some face lift here and there. Once the app is ok for public use, we will release for beta.</p>

<p><img src="http://i.imgur.com/710nEGW.jpg" alt="Icon" /><img src="http://i.imgur.com/wXn77tZ.jpg" alt="Login screen" /></p>

      </article>
    </div>
  </div>
</div>
<div class="colophon">
  <div class="container">
    <div class="row">
      <div class="author six offset-by-three columns">
        <img src="https://igcdn-photos-f-a.akamaihd.net/hphotos-ak-xfp1/t51.2885-15/e15/10617063_553407278119581_1973098870_n.jpg" class="avi"> <p>My name is Opeyemi Obembe. I build things for web and mobile. You should follow me on Twitter (<a href="http://twitter.com/kehers">@kehers</a>).</p>
      </div>
    </div>
    <div class="row p-t-20">
      <div class="six offset-by-three columns">
        
        
        
        <article class="m-t-20">
          <h4 class="title m-b-20">Next post</h4>
          <h5 class="libre no-margin"><a href="/2014/05/17/back-on-android.html">Back on Android</a></h5>
        </article>
        
        <h4 class="title">Comments</h4>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_shortname = 'kehers';
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="three offset-by-three columns">
        <a href="/">/opeyemi</a> · <a href="http://github.com/kehers/kehers.github.com">Source</a> · <a href="/feed.xml">RSS feed</a>
      </div>
      <div class="three columns">
        <a href="http://twitter.com/kehers">Twitter</a> · <a href="http://github.com/kehers">Github</a> · <a href="http://instagram.com/kehers">Instagram</a> · <a href="http://500px.com/kehers">500px</a>
    </div>
    </div>
  </div>
</footer>

<script type="text/javascript" src="/assets/js/menu.js"></script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-53373832-1', 'auto');
ga('send', 'pageview');
</script>

</body>
</html>